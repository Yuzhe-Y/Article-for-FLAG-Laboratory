# 从零开始的无人机制作过程v2.0

## 0. 写在开头

好久没有更新这个文章啦，从进组到现在已经一年多了，参加了大大小小的比赛，也接触到了许多有关无人机的知识，因此值此佳节时期，把一年前的这篇菜鸟知识点总结文章进行扩展，服务于更广泛的人群。  

本文主要分为以下部分：无人机物资采购及安装，无人机机载电脑系统基本配置，第一次起飞的准备。如有发现或有任何问题请与作者进行沟通及反馈，万分感谢！

相比于第一版，v2.0版本新增了：

## 1. 无人机物资采购及安装

该段落主要介绍从零开始搭建一架无人机都需要采购什么材料，如何去设计一架无人机，以及整体组装过程中需要注意的事情。

### 1.1 你该如何选择适合你的无人机

从零开始造一架无人机是很困难的，首先你需要知道，你为什么造这个无人机，是为了**在实验室环境中验证自己的算法**，还是为了**参加一个在户外飞飞机的比赛**，是只需要**动作捕捉系统**，还是说需要**激光雷达以及视觉**？我们需要先了解自己的需求，明确需求后再去选择合适的零部件来造出我们的第一架无人机

不同场景需要不同的无人机，我们可以通过下述列表来进行挑选：

- **定位系统**：动作捕捉系统、激光雷达定位、视觉定位、GPS定位

- **机载电脑**：NUC，Jetson，其他小电脑

- **尺寸**：小尺寸（150mm轴距），中尺寸（250mm轴距），大尺寸（350mm轴距）

- **续航与性能**：电池，飞机重量，电机，桨叶的配合

- **飞控与电调**：pixhawk6c与tmotor电调，nxtpx4飞控与微空电调

下面给出一些自己的无人机选型经验：

对于专注于规划控制算法开发的同学来说，由于仅需要在实验室环境下进行自己的科研算法验证，因此我们可以只使用动捕系统作为外部定位信息来源，对于使用强化学习等需要GPU计算单元的可以选用Jetson，其他情况还是用NUC。在实验室环境下，我们不需要考虑外部环境的影响，而且只是为了验证算法，我们可以选用较为小型的无人机，同时电池采用容量更小的型号。如果大家是做一些有关定位或感知方面的算法的话，定位系统、机载电脑等也需要特别审视。

而对于户外类型无人机，通常都需要激光雷达作为定位，同时需要满足一定的续航和抗风要求，尺寸上也需要满足比赛需求。

因此，我们需要首先分析我们需要什么样的无人机，在充分分析后，选择合适自己的无人机，能够达到事半功倍的效果

### 1.2 你都需要什么物资

从零开始造一个飞机，可不是你想象的那么简单，除了无人机上所必须的各种零件，我们还需要配备完整的工具，一个好厨子，不仅仅需要好的素材，也需要好的厨具

- **机架**：150mm轴距，200m轴距，250mm轴距，350mm轴距

- **机载电脑**：intel NUC（12代、13代、14代、15代），NVIDIA Jetson orin nx，NVIDIA Jetson AGX orin

- **激光雷达**：LIVOX MID360激光雷达（上置斜放，下置斜放）

- **电机**：T-Motor电机（不同类型）

- **螺旋桨**：T-Motor 3寸桨，4寸桨，5寸桨，7寸桨

- **飞控**：pixhawk 6c，nxtpx4

- **电调**：T-Motor电调（不同类型），微空蓝鸟电调

- **遥控器**：乐迪 AT9S PRO

- **遥控接收器**：R12DSM 2.4G 12通道

- **视觉相机**：INTEL D435i，单目相机

- **电池**：格氏电池，遥控器专用电池

- **降压模块**：淘宝商家定制

- **分电板**：FLAG实验室自制

此外，除了以上的重要元件，还有许多元件需要进行准备：

航模电池充电器、遥控器电池充电器、12AMG等规格供电线、xt30(60)立式(侧式)公母插头、热熔胶及热熔胶枪、扎带、魔术贴、电工胶、m3规格铝柱及螺丝、typec转usb线、电调与飞控通信线（10pin转8pin，10pin线端口GH1.25，8pin线端口SH1.0）、焊锡、焊台、焊油、吸锡器、八爪鱼、热缩管、万用表、螺丝刀、拐棒、**螺旋桨专用套杆**、激光雷达及相机专用线材、键盘、鼠标、电源适配器、显示屏、固态硬盘、内存、剥线钳、斜口钳、尖嘴钳、热风枪、镊子、欺骗器、纳米胶、布基胶、剪刀、壁纸刀、bb响

以上为无人机制作过程中所需要的大部分所需用具，如有遗漏；欢迎补充。

### 1.3 无人机具体结构的设计原理

在整体无人机设计的过程中，我们遇到了许多设计上相关的问题，比如在续航方面的选择。由于我们采用的是学长比赛时候的飞行器，其设计不适用于长距离、长时间飞行，因此在我们进行测试分析后，认为我们需要对无人机的具体结构上进行再设计以满足我们的需求。

无人机结构上可以通过改进来进行提升的地方主要有：飞行器整体结构的设计，电机及螺旋桨的选型、飞行器整体布局的选择等方面。

#### 1.3.1 飞行器整体结构的设计

在飞行器整体结构设计上，我们主要进行改进的地方有：**桨距的改变，轴距的改变**。准确来说，桨距的改变这个作用，我也才是第一次知道，在进行结构改进的过程中，改变桨距只是为了能够让9.5寸的桨能够顺利放进飞行器中且不打到主体结构，但是根据gpt以及文心一言的介绍，我们得到以下结论：

> 桨距较小，提供较高的推力，适合起飞和悬停等需要大升力的场景。但高速飞行时效率较低，会导致更多能量损耗。
>
> 桨距较大，提供更高的空气推进效率，适合巡航飞行或低载荷场景。但起飞时可能导致电机负载过大，增加耗电量。

因此，我们有以下结论：**对于长时间悬停任务，选择中小桨距以减少能量消耗，对于远距离巡航任务，选择大桨距以提升气动效率。**

在轴距上我们也做出了一定的调整，采用更长的轴距设定也能增加其续航，以下为gpt的回答：

> 螺旋桨之间距离更远，下洗气流相互干扰减少，提升气动效率。每个螺旋桨可以以较低的转速提供相同的升力，从而减少能耗。适当增加轴距可以提高气动效率，但轴距过大会增加机架重量。
>
> 大轴距惯性矩增大，姿态调整的幅度更精确且稳定。在巡航中，飞行器的动态平衡更容易维持，从而减少调整所需的能量。但响应速度稍慢，适合长时间飞行而非快速机动。
>
> 电机分布更广，推力分布更加均匀。在长时间巡航时，可以更好地保持飞行稳定性，减少能耗。

轴距的增大也会导致重量的增加，我们需确保增加的轴距所带来的气动效率和稳定性提升，能弥补因重量增加导致的额外功耗。

#### 1.3.2 电机及螺旋桨的选型

在原来的比赛中，飞行器选用的是kv值为925的电机以及8寸的螺旋桨，但是经过询问德龙学长以及子辰学长后，我们了解到采用**尺寸更大的螺旋桨及kv值更低的电机**有利于能耗的降低。通过上网查阅资料，我们能够知道：

> 选择低kv值及高效的电机：KV表示每伏电压下的电机空载转速，低KV值电机意味着较低转速和较高扭矩。低KV电机适合搭配大桨距或大直径螺旋桨，以低转速提供更高推力。更高效率的电机将减少发热和能量浪费，延长续航时间。
>
> 螺旋桨尺寸的增大：螺旋桨直径增加，能推动更大的空气量，从而在较低转速下产生足够的升力。较低的转速减少湍流和摩擦损失，提高气动效率。
>
> 选择直径较大的螺旋桨时，应配备低KV值电机以维持合理转速。

此外，我们可以通过电机官网，查阅电机相关文档来进行选型。以老虎电机为例，对于不同电机，官网文档中都会给出不同螺旋桨尺寸下不同推力下功率、拉力及其力效，通过对比力效及其他方面的参数，也能为我们的挑选提供参考。

#### 1.3.3 飞行器整体布局的改进

该部分主要以飞行器上的元件布局为主要介绍对象。

首先最重要的一点是：**注意飞控与电机旋转轴平面的关系，在实践中飞控应与电机输出轴最底端的绿色线圈在同一水平面上**。这个安装要求来自于德龙学长的提醒。其实根据网上查阅的资料我们得到飞控安装在飞行器重心处是最好的安装地点，因为接近重心的位置能减少姿态变化对传感器读数的干扰，提供更准确的运动信息。但我们在进行设计时一般难以估计飞行器重心的位置，因此我们将飞行器电机输出轴最底端的平面认为是重心所在平面。

其次，是飞行器各元件的布局。四旋翼飞行器要求我们做到重量分布对称，因此我们在进行设计的时候确保整体结构在大体上是对称的，如果存在无法与机架进行紧固的部分，我们也需要将其置于飞行器中心位置，减少因不对称产生的额外功率浪费。同时在上下重量的分布上我们也应做好设计，要求重心所在平面的上下部分重量分布大致一致，否则飞行器的控制难度将会增加。

### 1.4 整体组装过程中需要注意的事项

完成飞行器选型、设计及优化后，我们将进行飞行器的组装，接下来将会用列表的形式列出在安装过程中我们需要注意的地方。

1. 注意各个元件的安装顺序，不合理的安装顺序会大大延长装机时间，进行更换时也会更难操作，最好在进行设计时就考虑安装过程。

2. 注意元件安装的合理性，不合适的安装位置或其他不合理的地方容易导致安装时间的延长，操作难度增大。

3. 电调与电机的焊接需注意何时进行，过早焊接或过晚焊接都会使难度加大。此外，**12根电机三相线可以不按照一定的顺序进行焊接，只需要每三根电机线焊接在对应电调的三个连续的焊盘上即可**，顺序可以随后通过软件进行调整。

4. 电调焊接的时候供电线上的电容可以不进行焊接（也可以进行焊接来减少尖峰电流的冲击）。

5. 激光雷达一分三的线，其中有一根备用线不需要使用，另外两根根为网线和供电线，供电线在焊接的时候需要注意供电线正负极及屏蔽线的区分。

6. 激光雷达在安装的时候需要进行加固处理，减少激光雷达的抖动，并固定激光雷达的角度，方便其初始化。

7. 对电机进行固定的时候使用的螺丝不应过长，防止螺丝与电机线圈接触产生电火花，引发安全事故。

8. 螺旋桨安装的时候要求紧固，能够随电机转动而转动，防松螺母也需要紧固。

9. 注意螺旋桨安装的正反。螺旋桨分正螺旋桨与反螺旋桨，安装时根据电机转动方向进行不同安装。

10. 飞控与电调的通信线应按照飞控与电调的说明手册严格进行焊接（对于本机来说，采用10转8通信线，总共有5根线需要进行焊接，分别为地线，4根pwm控制线，飞控上总计10个接口，确定4个pwm控制线分别哪根线对应哪个电调上的1号端口，多余的线剪掉）。

11. 遥控与飞控的通信线为5转3线，购买遥控时需要一起进行购买，接在飞控 SBUS RC 接口处。（此条针对pixhawk系列飞控）

12. 注意激光雷达安装方向，连接一分三线的边为雷达的后端。

13. 电脑（NUC）以及其他的控制设备做好一定的防护，包括电气防护以及物理防护，可以增加3D打印保护壳或其他方式进行防护，减少铝柱与nuc接触的次数，采用绝缘的物体进行nuc安装，留出电脑风扇出风口。

14. 坠机后电脑如果开不了机，80%为内存或固态的问题，检查后更换即可，否则是电脑供电问题，需及时检修。

15. 升压降压模块做好绝缘，升压降压模块输入端与输出端最好不要采用压线的方法而是采用焊接的方法进行连线。

16. 分电板焊接注意焊接时的操作，做好绝缘，注意焊接插头的选择。

17. 整机电路一定做好绝缘，线缆安装时注意防止被螺旋桨打到，线缆长度合理布局。

18. 整机结构设计时尽可能压缩，即塔式结构不要堆叠太高，会使重心过高，难以控制。

19. **进行无人机组长时一定要注意安全，不要伤到自己！**

20. 注意nuc电脑和jetson电脑的区别，他们的供电方式等都有着不同的地方，如果不明白一定要及时询问学长

21. NUC14及更新的NUC采用DDR5内存，请注意他们与较老的NUC的区别

22. 注意无人机上所有零件的固定方式，需要确保固定稳固，尤其是电池等危险物品

以上为进行整机拼装及焊接时候需要注意的地方，如有补充，欢迎与作者联系。

## 2. 无人机机载电脑系统基础配置

本部分主要介绍机载电脑（NUC和Jetson）的ubuntu系统的安装（双系统配置），ubuntu环境基础配置（VSCODE，QGC，NoMachine，科学上网，git，网卡配置），程序相关环境配置（ROS系统，MAVROS，CasADI，激光雷达，Acados）三部分

由于我们现在使用的机载电脑有两种情况，**NUC**和**Jetson**，两种电脑的架构存在基本的差异（**x86**和**arm64**），因此两种系统在大部分情况下的环境配置都是不一样的。同时我们也需要服务在笔记本电脑上进行双系统安装或单独安装ubuntu的情况，因此本部分将被分为两大部分，分别介绍x86架构的笔记本电脑和NUC，以及arm64架构的Jetson

### 2.1 x86的系统安装

#### 2.1.1 ubuntu系统安装

在网上有许多关于虚拟机或双系统进行ubuntu系统安装的文章，在这里我就不做过多介绍，下面会列出一些相关文章共参考。作者采用的是双系统方式，相比于虚拟机，双系统能够很好的利用电脑的资源，但是与虚拟机相比，两个系统间无法直接进行文件的传输是最大的痛点，因此仁者见仁智者见智，大家可以上网搜索两者的对比，选择自己喜欢的方式进行安装。

在安装双系统的时候，大家大概率会出现这样的一个问题：明明我的系统盘已经制作好了，但是插入系统盘，选择u盘启动后，能听见ubuntu系统的声音，却看不到画面。大家不用担心，这个是正常的事情，是因为NVIDIA显卡驱动不兼容的问题导致的。大家可以选用两种方法进行解决，第一种是进入到windows系统中或bios中，选择核显进行启动，另一种是按照如下文章的方法利用指令进行核显启动。

对于大部分笔记本电脑，上述ubuntu系统安装基本都没有问题，但是对于某些机型（例如华硕天选等），安装双系统时需要重新进入bios进行一些特殊的修改，如果大家发现自己按照下述方法无法进行双系统安装，一定要及时**上网搜索**（在这个方面，**人类比AI强**）

此外，飞行器上的nuc由于采用ubuntu单系统，其安装步骤比双系统或虚拟机简单的多，因此在这里不做过多赘述。

**双系统安装**：

> [windows10 和 Ubuntu双系统安装](https://blog.csdn.net/LIWEI940638093/article/details/113726447)
>
> [U盘配置Ubuntu系统 ——（Win10+Ubuntu20.04）双系统安装教程](https://blog.csdn.net/WS_Change/article/details/141126131)
>
> [Ubuntu双系统安装](https://blog.csdn.net/jy15246781299/article/details/133667186)
>
> [Ubuntu18.04完整新手安装教程和分区设置](https://blog.csdn.net/chencaw/article/details/101106073)

**双系统安装时黑屏问题解决**：

> [ubuntu安装中黑屏卡住](https://www.zcbm580.com/pos/o7o3eve7g.html)
>
> [笔记本Ubuntu系统的显示问题：安装前黑屏、安装后黑屏、外接显示器黑屏](https://blog.csdn.net/weixin_45291614/article/details/135106749)

#### 2.1.2 UBUNTU环境基础配置

完成ubuntu系统的安装，接下来进行对应的ubuntu基础环境配置。我们主要所需的环境配置为：基础软件如vscode等的安装，基础配件如clash的安装等

> **在NUC上进行安装后，重启开机时首先关注是否能够正确识别网卡（是否能够连接wifi），如果无法正常连接wifi，请首先完成网卡驱动的安装，随后再进行其他操作**

通常情况下，我们所需的基础软件主要有：VSCODE，QGC（QGroundControl），NoMachine

这些软件的安装教程网上一抓一大把，可以根据网上的教程完成相关的配置，不过多在这里进行阐述

除开以上的基础软件，我们还需要对我们电脑的一些基础环境进行对应配置，最主要的就是科学上网与代码管理。

科学上网，在ubuntu系统中我们采用clash verge。大家可以通过上网搜索，马上找到对应clash verge的最新版本，但大部分人经过尝试后都发现，clash verge v1.3.8能够进行安装，但是双击后会发现没有图形化界面出现，通过与学长交流后，他们也被这个问题困扰了许久，大部分人都是通过在终端中键入命令来进行科学上网的。因此，有一个方便的图形化界面十分重要。

经过我在网络上的不断搜索，终于在一个帖子中找到了一个可能的解决办法。在这个帖子中，提问人也是受到没有图形化界面的困扰，clash verge的上传作者最终推荐使用clash verge v1.3.8的debug版本，最终成功解决该问题。我也使用同样的方法，最终成功实现了clash verge的图形化，下面贴上网址连接：[Clash Verge Alpha](https://github.com/zzzgydi/clash-verge/releases/tag/alpha)

在该网址中选择`clash-verge_1.3.8_amd64-debug.AppImage`进行下载，并将其放入ubuntu系统中，使用

``` sudo chmod +x /path/to/clash-verge_1.3.8_amd64-debug.AppImage ```

赋予clash verge权限，然后直接双击clash verge或终端中输入`./clash-verge_1.3.8_amd64-debug.AppImage`启动clash verge

经作者测试，对于ubuntu20.04系统，该版本能够正常显示clash verge图形化界面，大大降低终端键入成本。

网络上同时也提供了使用更低的版本如v1.3.5的方法进行解决，但作者还没有进行测试，感兴趣的可以测试一下。当然，这个版本的clash verge还是存在一些小问题比如当开启时间过长会导致cpu占用率升高（风扇酷酷转），不过还是在能接受的范围内的。（241125补充：安装nvidia显卡驱动后问题消失，可以完全放心使用clash verge alpha v1.3.8）

对于科学上网，学长们也提供了其他方式，例如cfw等

**如果自己对ubuntu的代理方面不太熟悉，请一定只选择一种科学上网的工具，否则你的整个系统网络代理会变得异常混乱**

**上述clash verge alpha版本可能存在破坏系统网络代理配置的情况，可能会导致docker无法拉取官方镜像，慎重安装！！！**

另外一个必备的，就是git。git作为代码管理工具，对于这种需要多人协作的中型工作场景十分有用。网络上针对git进行配置的教程还是比较多的，大家可以上网自行搜索安装。安装完git后，也可以进行ssh免密连接github或gitee的操作：[Ubuntu系统SSH免密连接Github配置方法](https://blog.csdn.net/jks212454/article/details/140372251)

对于我们的笔记本或台式机，一般不会出现系统配置完后无法联网的情况，但是对于我们使用过的nuc，我们发现在安装完系统后，系统右上角并没有出现WIFI图标，并且在设置中我们也没有找到WIFI相关配置。通过上网查询后发现是网卡驱动缺失。解决办法也很简单，通过阅读下面给出的文章即可解决问题：[Ubuntu20.04无线网卡驱动错误解决方法](https://zhuanlan.zhihu.com/p/28175318985)

此外，可以选用[Ubuntu20.04上无法识别英特尔WiFi6EAX211无线网卡](https://blog.csdn.net/u011391361/article/details/137016824)提及的方法，但是该方法在多次验证之后，无法确保100%可行，经常出现使用该方法后仍然无法识别的情况，请大家慎重考虑上述的方法

#### 2.1.3 程序相关环境配置

本部分主要介绍程序相关的环境配置。环境配置主要有：ROS系统，MAVROS，CasADI，激光雷达，Acados，PlotJuggler。请大家严格按照文中的方法进行安装，确保每一个检验步骤都能通过

##### 2.1.3.1 ROS系统配置

对于第一次使用ubuntu系统或对ubuntu系统还是不是很熟悉的读者可以按照下面列出的文章中的安装方式进行一键安装，简单省时省事省力，奶奶来了都能装上，就是会臃肿一点。如果认为自己对ubuntu很熟悉、想节省空间或想探索的读者也可以自己上网搜索安装方法。注意安装版本为 **ROS1 ROS Noetic（20.04对应）**

> [鱼香ROS网站上线|一行代码安装ROS/ROS2/解决rosdep问题|小鱼脚本](https://blog.csdn.net/qq_27865227/article/details/120277420)

##### 2.1.3.2 MAVROS安装

这部分主要是针对px4系统及mavros的安装。这部分花费的时间比较长，但是网络上的参考文档还是比较多的，在这里面主要推荐三个文档，其中第一个文档为px4官方提供的安装文档，可以着重参考这个，其他两个也可以参考。都看看没有坏处。

> [ROS (1) with MAVROS Installation Guide](https://docs.px4.io/main/en/ros/mavros_installation.html)
>
> [Ubuntu20.04+ROS1+PX4+Gazebo仿真（三）环境配置](https://www.bilibili.com/opus/934654041226477571?plat_id=35&share_from=article&share_medium=android&share_plat=android&share_source=WEIXIN&share_tag=s_i&spmid=read.column-detail.0.0&timestamp=1732106115&unique_k=MLoAwwz)
>
> [Ubuntu20.04+MAVROS+PX4+Gazebo保姆级安装教程](https://www.bilibili.com/opus/782824589525778437?plat_id=35&share_from=article&share_medium=android&share_plat=android&share_source=WEIXIN&share_tag=s_i&spmid=read.column-detail.0.0&timestamp=1732106126&unique_k=sAvZvPG)

其中有一点需要注意的是安装完px4后利用后两个教程的指导，是能够正常让无人机起飞及降落的，大家注意一下。

此外，在安装mavros的时候有两种方式，分别为二进制安装以及源码安装，这两种安装方式均可，作者采用的是第一种方法，经过询问后第二种方法也能成功。

##### 2.1.3.3 CasADI安装

CasADI是一个开源的计算机代数系统，专注于提供用于自动微分和非线性优化的功能。程序中使用他主要用来进行NMPC中非线性部分的求解。针对这一部分的安装，德龙学长留下了一篇安装文档供我们参考：[Ipopt和CasADi安装配置](https://github.com/Hydrogen2000/Installation-of-Ipopt-and-CasADi)

读者可以自行根据文章中的内容和提供的参考资料进行安装，德龙学长已经将安装内容写的很详细了。

**！！！注意！！！**

**按照以上步骤完成Ipopt和CasADI安装后，大部分情况下都是能够正常运行的，但是在我们组装的无人机NUC上，运行代码后会产生报错，通过阅读报错原因显示为Ipopt没有安装，我们猜测可能是部分环境没有进行配置**，因此上网搜索安装教程，根据该教程：[Ubuntu 20.04源码安装Ipopt](https://blog.csdn.net/tianjunc/article/details/143319954)，我们最终发现在这篇文章的最后一步中，除了针对

```bash
sudo cp coin-or coin -r
```

的修改外，文章中还对环境进行了如下的更改：

```bash
sudo ln -s /usr/local/lib/libcoinmumps.so.3 /usr/lib/libcoinmumps.so.3
sudo ln -s /usr/local/lib/libcoinhsl.so.2 /usr/lib/libcoinhsl.so.2
sudo ln -s /usr/local/lib/libipopt.so.3 /usr/lib/libipopt.so.3
```

增加以上环境变量配置后成功运行程序。

##### 2.1.3.4 激光雷达环境配置

无人机上采用的激光雷达为Livox MID360，因此我们在配置环境的时候SDK采用Livox SDK2，雷达驱动采用livox_ros_driver2。网络上有许多相关的配置文档，在这里我列出几个供大家参考：

> [Livox-Mid-360激光雷达配置](https://blog.csdn.net/m0_49384824/article/details/142483862)
>
> [Livox-mid-360激光雷达ip配置](https://blog.csdn.net/Hahalim/article/details/129414327?ops_request_misc=&request_id=&biz_id=102&utm_term=%E5%A4%9Amid360%E6%BF%80%E5%85%89%E9%9B%B7%E8%BE%BE%E6%A0%87%E5%AE%9A&utm_medium=distribute.pc_search_result.none-task-blog-2~all~sobaiduweb~default-6-129414327.142%5Ev100%5Epc_search_result_base2&spm=1018.2226.3001.4187)
>
> [Livox mid360 激光雷达运行 fast-lio2 详细教程](https://blog.csdn.net/m0_55117804/article/details/142644882)

在这里面大家需要注意一点，在进行livox_ros_driver2的安装时，最后一步

```bash
./build.sh ROS1
```

需要在 **../src/livox_ros_driver2** 这个文件夹下进行

**！！！注意！！！**

**不论是使用我们程序中淏宇学长修改的 ra-lio SLAM算法，还是开源的SLAM算法例如 fast-lio2，都应在对应存放SLAM算法的工作空间中将文件夹 ws_livox/src/ 中的 livox_ros_driver 文件夹复制过去（作者使用的这两个SLAM算法均为这种情况，其他SLAM算法按照对应网页介绍或相关教程处理）**

##### 2.1.3.5 ACADOS环境配置

acados是一种专注于高性能、嵌入式系统实时应用的最优控制问题（OCP）求解框架，主要用于求解非线性模型预测控制（NMPC）问题，基于python语言进行开发，包含了多种用于NLP（非线性规划）问题的求解器。起源于2020年，经过近几年的维护，技术更加成熟，已经有多个项目及论文开始使用其作为NMPC控制器的求解器，在新框架中，无人机NMPC控制器也采用ACADOS作为非线性规划问题的求解器。

ACADOS的官方文档如下[acados](https://docs.acados.org/)，在官方文档中，你可以找到许多相关知识，包括如何进行安装，如何进行使用，当然，你也可以通过其官方论坛[acaods forum](https://discourse.acados.org/)获取不同问题的解决方法。

ACADOS主要的开发环境为python，但是其也配备的python转换c语言的模块，因此我们可以通过编写python程序，从而自动获得c语言形式等价代码。

**ACADOS的安装过程也比较简单，先按照[Installation](https://docs.acados.org/installation/index.html)中的ubuntu部分，进行基础代码库克隆及编译，随后按照[Python Interface](https://docs.acados.org/python_interface/index.html)中的Installation部分进行python库安装编译，即可实现ACADOS的安装，最后实现的效果是：进入到`<acados_root>/examples/acados_python/getting_started`文件夹后，运行`python3 minimal_example_ocp.py`后，程序能够正常运行，不出现报错，最终得到图像。**

由于ACADOS现在还在进行开发，暂时没有稳定版本，因此在不同时间从GitHub上拉取的ACADOS源码会有不同，同一份控制器代码，会因为不同版本的ACADOS而产生报错，因此我们最好在拉取时进行版本统一。目前新框架基于的版本为25年3月，commit id为`9359d9ef6e6d5a16867455240a968e8aa9421c76`，通过在`git clone https://github.com/acados/acados.git`后进行分支切换`git checkout 9359d9ef6e6d5a16867455240a968e8aa9421c76`实现版本管理

同时需要注意的是，ACADOS安装部分的最后一步，即进行测试，在进行第一次测试时，会要求安装`tera_render`，终端中会提示你是选择自动安装还是手动安装。目前来说，自动安装已经很稳定了，但是如果自动安装不行的话，也可以按照终端提示或阅读文档进行手动安装。对于arm64架构，需要进行手动编译才能安装`tera_render`，详情见后文。

##### 2.1.3.6 PlotJuggler环境配置

PlotJuggler是我们在进行ros记录分析过程中最常用的软件，其安装过程比较简单，基于[ros的可视化看bag工具plotjuggler安装](https://blog.csdn.net/u014318178/article/details/133270424)中的文档即可实现安装和使用

## 3. 第一次起飞的准备

完成上面所有的无人机组装工作与NUC环境配置工作后，我们正式开始让无人机起飞啦。

首先我们需要针对QGC以及PX4飞控进行一定的文档了解，[ PX4自动驾驶用户指南(v1.13)](http://docs.px4.io/v1.13/zh/)是我们进行初步了解最重要的指南手册。通过该指南手册，我们可以快速上手PX4飞控以及QGC地面站。

作者推荐阅读该文档中的：

1. Introduction（简介）
2. Getting Started（入门指南） 中除  Payloads and Cameras（载荷&相机） 外的全部内容
3. Basic Assembly（基本装配） 中的 Mounting the Flight Controller（安装飞控）, Vibration Isolation（震动隔离）, Holybro Pixhawk 6C Wiring Quick Start
4. Basic Configuration（基本配置） 中的所有内容
5. Flying（飞行） 中的 First Flight Guidelines（首次飞行指南） 和 Flying 101（飞行基础指南）
6. Flight Log Analysis（飞行日志分析）
7. Advanced Configuration（高级配置） 中的 Finding/Updating Parameters（查找/更新参数） 和 Multicopter Configuration（多旋翼配置/调试）
8. Hardware (Drones & Drone Parts)（硬件） 中有关 Holybro Pixhawk 6C 的部分
9. Development（开发） 中的 Concepts（概念） - PX4 Flight Stack Architecture（PX4飞行器堆栈结构） 和 Controller Diagrams（控制器框图）
10. Drone Apps & APIs（无人机应用程序） 中的 Offboard Control from Linux 和 ROS - ROS (1) with MAVROS - MAVROS *Offboard* control example (C++)

该文档中的其他内容也非常值得阅读，如果有时间的话就把整个文档都读一遍吧。

**v2.0版本更新**

目前我们正在进行PX4飞控硬件和软件更新，目前应用PX4硬件为pixhawk v6c和nxtpx4，PX4软件为v1.13.3和v1.15.4。目前来说pixhawk v6c和v1.13.3更为稳定，其他两个仍然在测试中，因此本文档仍然以稳定版为主

### 3.0 注意须知

在进行第一次起飞准备前，请确保飞控周围没有大电流干扰（无人机电池不上电，让飞控连接笔记本地面站），确保所有线缆全部连接且连接顺序正确，确保所有线缆完全绝缘

### 3.1 遥控器配对

遥控器配对比较简单，首先确保周围仅存在一个即将配对的遥控器，随后长按遥控接收器侧面的小按钮，等待遥控接收器上面的指示灯闪烁，松开，观察遥控及遥控接收器，如果遥控接收器上的指示灯等待几秒变为长亮且遥控器上显示出类似于信号满格的图像后代表配对成功。

### 3.2 地面站校准飞控

打开QGC，点击左上角QGC标志+"Vehicle Setup"进入设置界面，设置界面中有许多需要调整的选项。

首先查看飞控的概况。对于一个全新的 Holybro Pixhawk 6C 飞控， 其固件版本应该是 v1.13.3 （或v1.13的其他版本），若不是，参照下方的烧录固件文档重新进行固件烧录。

第二步，进行机架调整。在左侧选择“机架”，找到众多选择中的“Quadrotor X（四旋翼无人机X型）”，点击下拉列表中的 “Generic Quadcopter“ 或 “Generic Racer 250“，对于轴距为250的无人机，优先推荐后面的选型


第三步，进行传感器校正。对于四旋翼飞行器，总共需要进行校准的传感器有：**罗盘、陀螺仪、加速度计、水平地平线**，在进行校准前，首先要进行飞控方向的选择。如下图所示，飞控方向可以进行选择，其中包括三轴角度的偏置。在飞行器设计的时候，飞控三轴并没有进行旋转等操作，因此此选项选择 “ROTATION_NONE”，按确定，开始进行校准。按照画面中显示的飞机（飞控）放置方向进行传感器的校准，注意QGC的提示是旋转机身还是静止放置。当框体全部变绿即校准完成。

**！！！注意！！！**

1. **进行传感器校准的时候请断开电池电源，电流磁效应可能会影响传感器的校准。**
2. **当传感器校准需要旋转机身的时候，请尽可能保持机身角度稳定，并进行柔和的左右旋转。**
3. **若调整或取下飞控再重新安装，或来到不同城市后、周围环境变化较大，均应重新对飞控传感器进行校准。**
4. **如果出现完成校正后提示校准失败，请重新进行校准，如果出现多次校准失败，请尝试换人，换场地，重新启动QGC，重新连接飞控**
5. **正常情况下 Pixhawk 6C 飞控的 “ROTATION_NONE” 方向为飞控正放（IMU模块向上且IMU模块朝向为无人机x轴增加方向），如果无人机飞控放置方式与这种方式不同，请及时修改**

对于罗盘校正和陀螺仪校正，我们需要对六个方向分别进行校正，罗盘校正需要旋转机身，陀螺仪校正不需要旋转机身，到达选定方向后静止等待校正完成即可。对于加速度计和水平地平线校正，仅需要将无人机平放在水平地面上进行静止校正即可。

第三步，完成校准后，我们进行遥控器对频及摇杆拨杆通道测试。无人机遥控器分为两种设计，油门摇杆位于左侧（日本手）和油门摇杆位于右侧（美国手）。在我们大部分应用场景中，我们的遥控都是油门摇杆在右，因此当我们进入下面第一个界面的时候，首先查看右侧选项是否为美国手，若不是，则改为美国手。随后，我们推动遥控左右摇杆，观察通道是否正确且是否反向。

**在第一次起飞前，推荐大家都能重新对遥控器进行校正**，当遥控器配对成功后，点击该页面中的校正，随后根据右侧遥控器遥感提示，将左侧摇杆拉至最低处，右侧摇杆回正（处于正中间），随后点击下一步开始进行校正。在校正过程中，根据右侧摇杆示意图的提示，将摇杆拨到对应的位置后保持，直到下一个新的摇杆示意图出现。等待所有摇杆全部校正完成后，点击下一步完成摇杆校正。

**！！！注意！！！**

**无人机遥控摇杆通道分别为：左摇杆上下：油门控制（z轴控制，采用HOLD方式），左摇杆左右：方向控制（yaw角控制），右摇杆上下：前进后退控制（pitch角控制），右摇杆左右：左偏右偏控制（roll角控制）。**

随后针对遥控上的拨杆，我们也要进行调整。我们采用的遥控正面上方总共有4个拨杆（两个摇杆上方），我们利用的为右侧3个拨杆（最左侧的不用）。点击QGC左侧的“飞行模式”，来到飞行模式设置页面，分配从左到右第三个拨杆（第五通道，channel 5）为飞行模式设置拨杆，下方的六个飞行模式中，飞行模式1设置为 "Manual"，飞行模式4设置为 "Position"，飞行模式6设置为 "Land"，其余均保持 "Unassigned" 不变，各飞行模式功能在PX4文档中都有详细介绍，这里不再过多叙述。随后，将右侧 “Emergency Kill switch channel” 分配到从左到右第四个拨杆（第十一通道，channel 11）。该拨杆的作用是紧急停止动力，只要拨杆拨至下方，无人机螺旋桨将不再输出动力（**此拨杆优先级最高**）。将右侧 “Offboardl switch channel” 分配到从左到右第二个拨杆（第九通道，channel 9）。该拨杆的作用是手动进行offboard模式的切换，正常情况下该拨杆应一直处于拨上位置。

第四步，进行电机测试及方向校正。在此阶段，**请务必确保飞机上的螺旋桨已经被取下**。对于我们的四旋翼无人机来说，我们对电机的控制采用PWM波的形式，通过飞控向电调发送控制指令，电调向电机提供三相PWM电压来进行控制，因此，电机转向既可以通过硬件方式（重新焊接）来解决，也可以通过软件修改来解决。首先确保 **螺旋桨已经卸下且电调与电机的三相线，电调与飞控的通信线连接良好**，随后点击QGC左侧的“电机”，将最下面的小滑块拉至右侧高亮，此时就会看到上面五个滑动条均可以拉动。通过拉动每个编号的滑动条，可以让电机转动，从而检测电机是否能够正常转动且转动方向是否正确。若电机转向不正确，利用下面的语句，即可完成转向：点击左上角QGC标志+"Analyze Tools"进入分析工具界面，点击“Mavlink控制台“，输入：

```bash
dshot reverse -m 2 #2代表2号电机，可根据不同电机将2改为1或其他数字
dshot save -m 2
```

即可完成电机转向。

完成电机转向后，在控制台中输入 `reboot` 进行飞控重启，这种方法同样可以用于参数更改后的飞控重启，重启后返回主界面，注意观察左上角飞控状态变为 "Communication Lost" 后点击其右侧的 “重新连接”，等待飞控的重新连接

**！！！注意！！！**

**无人机电机顺序为（飞控正方向朝向）：1号电机：右上电机，逆转（CCW）；2号电机：左下电机，逆转（CCW）；3号电机：左上电机，正转（CW）；4号电机：右下电机，正转（CW）。**

**无人机螺旋桨顺序为：1号电机、2号电机：正桨（标记为P或CCW，逆时针旋转）；3号电机、4号电机：反桨（标记为R或CW，顺时针旋转）。**

**完成上述电机转向更改后，请重新进行测试，如果测试后电机转向仍然无法改变，则需要重新焊接对应电机的三相线，进行电机转向**

第五步，更改参数。我们需要对以下的参数进行修改。

点击左侧“参数”，在搜索栏中搜索“dshot”，随后点击“DSHOT_CONFIG”，将“DISABLE”改为“Dshot600”。搜索“sys”，随后点击“SYS_USE_IO”，将"IO enable(RC & PWM)"改为"IO disable(RC only)"。搜索“aid”，点击“EKF2_AID_MASK”，将“1”改为“24”，下方只勾选“vision position fusion”和“vision yaw fusion”。搜索“hgt”，点击“EKF2_HGT_MODE”，将选项改为“Vision”。搜索“delay”，你将会看到许多形式为“EKF2\_...\_DELAY”的参数（总计应为8个），将“EKF2_EV_DELAY”改为“50.0ms”，其余均改为“0.0ms”。

### 3.3 遥控器设置

当我们设置完QGC之后，我们将会对遥控器进行最终设定。

我们使用的是 乐迪 AT9S PRO 遥控器。针对我们使用的四旋翼无人机，我们需要进行以下设定：长按遥控器下方“MODE”按键进入到遥控器设定界面，拨动右侧圆盘找到“机型选择”，点击右侧“确定”后找到”机型“选项，选择“多旋翼模型”。随后返回到设置界面，找到“功能设置”，进入后分别将“通道选择”改为“12CH”以及将“OUT”改为“SBUS”，即完成所有遥控器的设置。

### 3.4 飞控固件烧录与更改传感器通信频率

本部分内容主要针对飞控与上位机通信频率的修改以及烧录飞控固件的有关操作。

如果我们没有修改过飞控固件中的任何参数，Holybro Pixhawk 6C 将会以60hz的频率进行imu数据的采样，根据采样定理，能够完整复现imu数据且进行卡尔曼滤波处理的最大工作频率为30hz。根据采样定理，此时我们整个状态机及其他利用到这些数据的程序，其最大工作频率将只有15hz，因此，状态机中nmpc进行控制的程序，其最大工作频率将只有15hz，这对于我们来说是不可接受的。因此，我们需要修改通信频率，使通信频率达到100hz，这样我们的状态机将会以50hz的频率进行运行，imu的采样频率也将会来到最高200hz（准确来说，Holybro Pixhawk 6C 上的imu最高采样频率为190hz）

首先进行固件下载，打开下面的网址：[PX4_v1.13.3_固件](https://github.com/PX4/PX4-Autopilot/releases/tag/v1.13.3) 或 [PX4固件github库](https://github.com/PX4/PX4-Autopilot)，将固件克隆到本地。

```bash
git clone -b v1.13.3 --recursive https://github.com/PX4/PX4-Autopilot.git  #也可以是其他v1.13版本，语句可能有不同
```

随后直接在文件夹中打开 mavlink_main.cpp，进行全局搜索，搜索 “30.0f”，你将会看到总共有8个搜索项，全部与 “LOCAL_POSITION_NED” 和 “ODOMETRY” 有关。将8个所有的 “30.0f” 改为 “100.0f” 并保存。

保存后进行程序编译。我们使用的飞控是 Holybro Pixhawk 6C，因此我们采用如下语句进行编译并进行烧录：

```bash
make px4_fmu-v6c_default #编译文件
make px4_fmu-v6c_default upload #烧录固件
```

此外，完成编译后我们也可以在QGC中进行固件烧录，点击左侧“固件”，重新插拔飞控与电脑的USB，随后就会产生提示框“固件设置”，点击下方的“高级设置”，选择“自定义固件文件”并点击上方的确定，即可自主选择要烧录的固件。找到编译好的 .px4 文件并进行烧录即可。

下方也将列出一些有关烧录方面的文章供大家参考：

[PX4开源飞控--开发环境搭建 编译仿真及烧录](https://blog.csdn.net/zhoubiaodi/article/details/138303475)

### 3.5 飞行日志读取与分析

飞行日志是我们了解无人机飞行状况的一大利器，通过阅读飞行日志，我们能够了解到无人机整个飞行过程中的状态以及存在的问题。

点击左上角QGC标志+"Analyze Tools"进入分析工具界面，出现的就是“日志下载”界面。点击右侧的“刷新”，即可看到全部的飞行日志。由于飞行日志上显示的时间并不是我们现在的时间，我们可以通过时间顺序来查看最近的日志，或者可以点击“擦除全部”，从而记录下一次的飞行日志。如果想要下载飞行日志，则点击要下载的日志，随后点击右侧的“下载”，即可将日志下载至本地。

我们可以利用该网站进行飞行日志查看[PX4 Flight Review](https://logs.px4.io/)，将下载的飞行日志上传，并填写油箱（随便一个），点击“upload”，即可完成飞行日志上传。

在这里我同时介绍一下悬停推力测量的方法：利用mavros中提供的位置控制指令，固定其飞行位置，并记录本次飞行日志，进行查看后直接拉至含有“Thrust”的图表，观察其悬停推力即可。

### 3.6 动作捕捉系统使用

动作捕捉系统，通过在三维空间布置多个视频捕捉设备或惯性传感器，记录运动物体的位置变化，并通过计算机处理获得不同时间点的空间坐标。在我们进行实验的过程中，无论是否使用动作捕捉系统来提供外部定位，动捕都是一个很有用的东西，我们可以通过动捕来区分和验证自己使用的SLAM算法或者程序是否存在问题。

#### 3.6.1 动作捕捉系统软件

动作捕捉系统主要由三个部分组成：动作捕捉系统主机，宿主机动作捕捉系统软件，客户机接收程序。动作捕捉系统目前安置于国防科技园6号楼104，由22个高精度相机构成一个“日”字形场地，其中我们最经常使用的是最深处的一片正方形动捕。

动捕系统工作原理为：动作捕捉系统主机通过22个高精度相机采集到的动捕球数据信息，经过计算得到动捕球所存在的无人机的姿态和位置，随后将该信息通过动作捕捉系统主机上的网线或wifi信号，发送到所存在的局域网中，最终由客户机接收程序接收到该信息，并发布到ROS网络中，供我们的程序使用。

那么宿主机动作捕捉系统软件起到什么作用呢？我们通过网线或wifi接入到局域网中，随后我们可以利用宿主机动作捕捉系统软件，选定哪些动捕球是我们所需要的（框选中动捕球组后，主机即可自动计算选中动捕球组的位置和姿态，并将其发送到局域网中），也可以对动捕系统进行精度标定。

软件

#### 3.6.2 动作捕捉系统标定

当实验室环境出现较大变动，或长时间不使用动捕后，基本上我们需要对动作捕捉系统进行重新标定，以提升动作捕捉系统的精度。

**注意，在进行动作捕捉系统标定的过程中，请首先检查身上穿着的衣物以及鞋子等随身物品，部分衣物或鞋子存在有与动捕球同样材质的反光条，在标定的过程中，会被误识别为动捕球，一定程度上会影响标定效果！**

首先，在进行标定前，目视104范围内是否存在暴露在动捕视线范围内的动捕球，如果存在，采用其他物品进行遮挡或者将其进行收纳。

随后，打开宿主机动作捕捉系统软件，分别查看每个动捕摄像头的画面，右键对应摄像头画面，点击“”后，将摄像头类型切换至“”，可以查看该摄像头的红外画面，在该画面下，如果画面中出现白色圆形光点，则需对对应位置进行检查，确认是否有对应的未发现的动捕球，如果发现则对应进行处理。

随后，正式开始我们的动捕标定工作，我们可以利用下面两个文章中的内容进行我们的动捕标定

> [OptiTrack Motive 使用教程](https://blog.csdn.net/weixin_49703603/article/details/111396118)

> [Optitrack与ROS详细教程以及Motive的使用](https://blog.csdn.net/weixin_41536025/article/details/89913961)

注意，在进行标定的过程中，我们会用到一个T型杆和L型三角块，T型标定杆用于第一阶段采集标定点，L型标定杆用于第二阶段确定地面及原点。

最终，我们会得到一个后缀为`.cal`的标定文件，以后我们即可使用这个标定文件

#### 3.6.2 动作捕捉系统使用

我们首先需要在我们无人机NUC或其他计算单元上首先安装客户机接收程序，按照[安装vrpn_client_ros库将动捕数据转换ROS话题](https://blog.csdn.net/weixin_45031928/article/details/142050198)文章中的方式进行安装。安装后，我们可以在我们的Motive软件对应电脑上查看动作捕捉系统局域网的IP地址，并将客户机接收程序中的launch文件中的

```
server: 192.168.1.2
```

进行替换

随后，我们打开宿主机动作捕捉系统软件Motive，注意，**一定要插上对应的加密狗U盘，否则无法启动软件**

打开后，我们选择左上角`file`中的`open`，打开我们得到的标定文件，随后，找到屏幕上对应无人机上的动捕球组，使用左键框选中并右键点击“”，创造对应刚体，并进行命名`name`，随后使用roslaunch启动客户机接收程序，查看对应ROS话题，如果在话题中出现`vrpn_cilent_ros/name/pose`，即认为已经成功完成传输

## 4. 代码讲解

本部分为本次比赛采用代码的对应原理讲解部分。本次比赛代码总共分为路径规划，运动控制与状态机，SLAM（同步定位与建图），视觉识别四部分，分别由：左远航（路径规划），杨宇哲（运动控制与状态机，SLAM），杨正南（视觉识别）三位同学负责。有任何有关代码上的问题请与这三位学长进行联系。此外，代码的构建还离不开实验室各位师兄师姐的贡献，是他们为我们提供了本次比赛的代码基础平台，大大减少了我们的工作量。如果存在我们无法解释的问题，还可以联系下列学长进行解答：路径规划：吴德龙学长，运动控制与状态机：华骏扬学长，施扬熹学长，SLAM：葛奕谷学长、杨淏宇学长，视觉识别：李昀皞同学。

### 4.1 路径规划部分讲解

等待补充。

### 4.2 运动控制及状态机部分讲解

状态机部分：https://meeting.tencent.com/crm/2y1gggQ242

涉及到源码部分讲解，请向 杨宇哲同学 申请权限。

### 4.3 SLAM部分讲解

等待补充。

### 4.4 视觉识别部分讲解

等待补充。
